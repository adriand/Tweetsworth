


Explain the project, that it was Tom's idea, and so on.


<p>Sinatra, the classy web development framework, just hit 1.0.  In honour of the occasion, we thought we'd whip up a Sinatra tutorial.</p>




Standard tutorials tend to show you how to build blogs.  I've always felt that was rather pointless.  Why wouldn't you just use WordPress?

Sure, you can learn a lot from building something familiar, but it's more fun to do something different.  That's why, in this tutorial, we're going to show you how to:

<ul>
  <li>Build a slick little web application that integrates with Twitter</li>
  <li>Hack APIs by using cURL and regular expressions instead of API wrappers and XML parsers (though we'll come to rely on those too)</li>
  <li>Learn to use <em>simple, powerful</em> tools like Sinatra and Datamapper instead of large frameworks like Rails to build small, focused web applications</li>
  <li>Spread your web app using social media (we'll try to make it go viral)</li>
</ul>





How To Create A Viral Website - Source Code Included!
=====================================================



<h2>About This Tutorial</h2>

In this tutorial, I'm going to focus on key source code elements and design decisions.  I'm not going to outline every single thing I do, or show detailed file structure layouts, or anything of that nature, because you can access the <a href="http://github.com/adriand/Tweetsworth">project's source code</a> itself if you're interested in that.

This tutorial assumes a basic knowledge of Ruby programming and subsidiary activities like gem installation, templating languages, and so on.

We're going to be using the just-released Sinatra 1.0 framework for this project:

<code>gem install sinatra</code>

We're also going to be using Datamapper (with SQLite for development, switching to MySQL later on) for the ORM, HAML, SASS and jQuery for views, and whatever we decide is the best solution for accessing Twitter's API when we get to that point.  Go ahead and install those various gems if you don't have them already.

Note that I've never had the opportunity to use SASS before, so please chime in if you see instances where I could improve the way I use it.

<h2>The Foundation</h2>

The meat of the app is tweetsworth.rb.  After building several Sinatra apps, I've developed a preference for a simple file structure and a simple base template for the main application (what you might call the application controller, if you're accustomed to Rails).

The file structure consists of the root folder, where the code for models and the main application goes, plus a folder for the database (/db), static assets (/public) and views (/views).

My application template looks like this (note the comments, which contain notes on some design decisions and idiosyncrasies of the technologies used:)

<script src="http://gist.github.com/332016.js?file=tweetsworth_base.rb"></script>

Next up: creating a quick and dirty layout that's good enough for us to build a functional prototype.  Once again, I rely on a few simple files that I've used and reused time and again for these purposes, making a few tweaks (centering the page and ripping off Twitter's background color).  We're also going to drop in jQuery 1.4 while we're at it.

The comments in this layout demonstrate two little tricks.  By using erb instead of HAML for the Javascript file, we retain Javascript syntax highlighting in our editor of choice, TextMate.  We also implement a simple version of Rails' flash messages, which are frequently useful.

Here's the basic layout, which is sure to change as we continue to develop the application (and particularly when we integrate a proper design):

<script src="http://gist.github.com/332418.js?file=layout.haml"></script>

At this point, everything is in place for us to be able to begin building some real functionality (if you're interested, this point is marked by commit <a href="http://github.com/adriand/Tweetsworth/tree/1f977aae3aba216cf80785f7090e74a67df08e9b">1f977aae3aba216cf80785f7090e74a67df08e9b</a>).


<h2>Getting User Information From Twitter</h2>

Although our goal is to always show a value of zero for the user's account, it will be more convincing - and also more fun to code - if we actually do connect to their Twitter account and retrieve information that we use as the basis for the valuation.  For now, we'll base the valuation on their number of followers and status updates.  This will also lay the groundwork for further integration later on if we like.

Making things nice and easy for us, the <a href="http://apiwiki.twitter.com/Twitter-REST-API-Method%3A-users%C2%A0show">Twitter API call for retrieving information on a user</a> does not require authentication.  You can get all the info you need just using cURL:

<code>curl http://api.twitter.com/1/users/show.xml?screen_name=adriandz</code>

This returns XML with all the information we're looking for.

Given how simple this is, three ways of getting this information in our app spring to mind.  The first is to use a Twitter-specific gem like <a href="http://github.com/hayesdavis/grackle">Grackle</a> or <a href="http://twitter.rubyforge.org/">twitter (the gem)</a>.  However, our requirements are so simple that we don't need something with a lot of functionality, nor do we need any OAuth or even basic authentication.

The second is to use a wrapper that will let us simplify the way we access this API.  My current preference for this is <a href="http://httparty.rubyforge.org/">HTTParty</a>.

The third is to just hack something quick and dirty that works with the bare minimum of external requirements.  We've already seen how using cURL lets us get the information we need in XML format.  We can actually skip utilizing an XML parser like Hpricot and just get the data using a regular expression:

<script src="http://gist.github.com/332181.js?file=twitter_info_via_curl.rb"></script>

If we run this from the command line like:

<code>ruby twitter_info_via_curl.rb tomcreighton</code>

We'll get:

Followers: 83<br />
Statuses: 384

Supply your Twitter username as the last argument (in place of <em>tomcreighton</em>) if you'd like to try this on your own account.

That's about as simple as it gets.  This is a nice technique for hacking APIs when the data you are interested in is simple, easy to parse, and doesn't include collections of items.  I've even used this for hacking SOAP services, by passing in the -H parameter to cURL:

<code>-H "Content-Type: application/soap+xml;charset=UTF-8"</code>

That said, although this works for our purposes, it won't serve us well if we want to add more interesting Twitter functionality later on.  We'll use HTTParty instead.

Helpfully, the <a href="http://httparty.rubyforge.org/">documentation for HTTParty</a> begins with a Twitter example, although it uses authentication, which we don't need.  Let's add httparty to the list of required gems (require 'httparty') and code up the simplest possible Twitter client that will be useful for our purposes, which we will drop into models.rb:

<script src="http://gist.github.com/332459.js?file=twitter.rb"></script>


<h2>Putting It Together</h2>

Now that we've figured out how to retrieve user information from Twitter, it's time to start putting it all together.  We're going to need to present the user with a form, retrieve their user information when they submit their Twitter username (or show a failure message if we cannot do so), and then start displaying values.

We'll also save valid Twitter usernames in our database so that we can use them, for instance to show other people whose accounts have recently been (under) valued, or perhaps so that we can send them a tweet later on about the app.

For that, we need a model:

<script src="http://gist.github.com/333150.js?file=Person.rb"></script>

Note that as soon as I've created this model, I stop the application from running.  Then, in the main app, I comment out the DataMapper upgrade method:

<code># DataMapper.auto_upgrade!</code>

And uncomment the migrate method:

<code>DataMapper.auto_migrate!</code>

Then I start the application back up again.  This will add in a table for my new model.  Subsequently, I change these lines back the way they were, so that we're back to upgrading.

We also need a form:

<script src="http://gist.github.com/333151.js?file=form.haml"></script>

And lastly, we need some logic in the main application to tie it all together:

<script src="http://gist.github.com/333152.js?file=controlled.rb"></script>

At this point, we are successfully retrieving information from Twitter, storing it in our database, and redirecting the user to a page where they can finally get an accurate estimate of just how valuable their Twitter account really is.  It's time for the fun part to begin.


<h2>Insulting People</h2>

After redirecting to the person's individual page, we're going to show them their results.  To make things convincing, we're going to display things as if we are calculating them on the fly, complete with progress indicators.

We're going to display three things.  First, a series of messages indicating progress, with each one appearing one after another, replacing the one displayed previously.  These will be in the form: "Evaluating Followers...", a pause, then "Questionable".

Second, when the progress messages have completed displaying, we'll slide out a results panel.  These results will be in the form: "Total Tweets: 981. You sure like the sound of your own voice."

And finally, we'll display a link encouraging users to sucker their friends into trying out our application by tweeting about it.

Let's start with the progress messages.  If you were paying attention to the little details in the layout file we created, you may have noticed that we put:

<code>= @js</code>

in the head section of the document.  This allows us, from within the main application, to specify a file with Javascript in it that will be rendered in this part of the document, as follows:

<code>@js = erb :person_js</code>

This is the logical equivalent of doing <code>content_for :scripts do</code> in conjunction with <code>yield :scripts</code> in Rails.  In this case, we've specified an erb file called person_js.erb to contain our Javascript for this view.

We'll also specify some progress statements in our main application file.  This will let us swap out progress statements easily later on, which we'll probably do later on as we polish the content:

<script src="http://gist.github.com/334355.js?file=progress_statements.rb"></script>

All that's left to do is write the progress statements into the view with a stylesheet declaration of display: none on them, and then write some Javascript to show them one after another.  We use Javascript's setTimeOut function for this.

When the progress statements have finished displaying, we slide down the pane containing the results of the evaluation.  The Javascript for displaying the progress bars and sliding down the results pane is pretty trivial, so I'm not going to display code for it.  Check the project repository if you're interested.

The insults, on the other hand, are just too much fun to exclude.  To keep things interesting, we'll show different insults for different ranges of values.  We'll also set insults up as arrays, so that we can add new ones easily later on.  Here's the code for insulting people according to their number of followers:

<script src="http://gist.github.com/346266.js?file=insult.rb"></script>





<h2>Going Viral</h2>

When it comes to going viral, there are no guarantees.  At this point we think we've developed something clever and funny, but perhaps no one else agrees.  Or perhaps people are unlikely to pass along something that is outright insulting.  Until we launch, it's hard to say.

However, there are things we can do to increase the likelihood that this will get passed along.

<ol>
  <li>Carefully refine the insults.  If the insults are lame, this isn't going anywhere.  We also sent out a request to friends for more jokes and received some excellent responses.  Bottom-line: if the content is weak, no amount of technical wizardry will help make something go viral.</li>
  <li>Provide a way to spread the site.  This is obvious, but needs to be mentioned.  In our case, we put a link on the results section of the site that lets people tweet a link to the site.</li>
  <li>Add A/B or multivariate testing to the page that encourages people to spread a link to the site.  I started out using Google's <a href="http://www.google.com/websiteoptimizer">Website Optimizer</a> for this task, but I got frustrated with how clunky it can be.  This is going to be fall into the wishlist category: if I find the time, I'll add it.</li>
  <li>Encourage people to participate in other ways.  At the end of the results page, we added in a request for people to send us more insults.  When we use submissions, we'll tweet back to the person who sent them in.  Someone who contributes to the site is far more likely to help spread it.</li>
</ol>









Letter for API rate limit:
--------------------------


The application is a humorous parody of Twitter account valuation tools.

Although a Twitter account has a subjective value (that can be high), I believe it is only truly valuable to the person who owns it - if I were to sell my Twitter account to a marketing company for example, my followers would quickly desert the account, rendering it worthless.  In other words, Twitter valuation tools are rather silly.

We took advantage of this to design a realistic-looking Twitter valuation site that, after performing many complex-sounding calculations, always returns a value of $0.00 for the person's Twitter account.  We're just looking to get a laugh, and for people to play the same prank on their friends.

You can try it yourself at:

http://tweetsworth.com

Because we're not going live until we get the API rate limit raised, you'll need to enter the following u/p to gain access:

tweetsworth / n1OBVxWz

The only method we are using is users/show

As far as predicted usage goes: as this is a joke site, we hope this spreads rapidly, but it's really only a one-time use type of thing.  If it goes viral we'll see a big spike of traffic but after that, I can't see it getting more than a couple of hundred visits a day.  I want the rate limit increased just to handle the spike of traffic if it does go viral.

I am requesting IP address whitelisting since we're not authenticating, as we don't actually need to for users/show

Thanks!
